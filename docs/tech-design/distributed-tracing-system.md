# AI Teams ÂàÜÂ∏ÉÂºèÁõëÊéßÁ≥ªÁªüÂÆûÊñΩÊåáÂçó

## Á≥ªÁªüÊ¶ÇËßà

**ÁõÆÊ†á**: ÊûÑÂª∫Âü∫‰∫é OpenTelemetry + Êú¨Âú∞ Jaeger + Grafana Cloud ÁöÑÊ∑∑ÂêàÁõëÊéßÊ†à

**Êû∂ÊûÑÂéüÂàô**:

- Êú¨Âú∞ Jaeger: ËøΩË∏™Ë∞ÉËØï
- Grafana Cloud: ‰ª™Ë°®Êùø + ÈïøÊúüÂ≠òÂÇ®
- ÁéØÂ¢ÉÊ†áÁ≠æ: dev/prod ÂÖ±‰∫´‰∫ëÁ´ØÂÆû‰æã

## Ê†∏ÂøÉÁªÑ‰ª∂

### Êú¨Âú∞‰øùÁïô

- **Jaeger**: Êú¨Âú∞ËøΩË∏™Ë∞ÉËØï (Á´ØÂè£ 16686)
- **Prometheus**: Áü≠ÊúüÊåáÊ†áÂ≠òÂÇ® (7 Â§©)
- **OTel Collector**: Êï∞ÊçÆÈ¢ÑÂ§ÑÁêÜ + ÁéØÂ¢ÉÊ†áÁ≠æÊ≥®ÂÖ•

### Grafana Cloud ÊõøÊç¢

- **Grafana UI**: Áªü‰∏Ä‰ª™Ë°®Êùø (ÂÖçË¥π: 5 Áî®Êà∑)
- **Mimir**: ÈïøÊúüÊåáÊ†áÂ≠òÂÇ® (ÂÖçË¥π: 10K series)
- **Loki**: Êó•ÂøóËÅöÂêà (ÂÖçË¥π: 50GB/Êúà)
- **OnCall**: ÂëäË≠¶ÁÆ°ÁêÜ (ÂÖçË¥π: 5 ÈõÜÊàê)

## ÂÆûÊñΩ‰ªªÂä°Ê∏ÖÂçï

### üéØ ÂøÖÈúÄÊ†áÁ≠æÈÖçÁΩÆ

ÊâÄÊúâÊåáÊ†áÂøÖÈ°ªÂåÖÂê´‰ª•‰∏ãÊ†áÁ≠æÔºö

```yaml
environment: "dev" | "prod" | "staging"
project: "starmates-ai-team"
service: "api-gateway" | "workflow-engine" | "workflow-agent"
```

### üìÅ Êñá‰ª∂ÂàõÂª∫‰ªªÂä°

#### 1. ÁõëÊéßÈÖçÁΩÆÊñá‰ª∂

- `monitoring/otel-collector-config.yml` - OTel Collector Ê∑∑ÂêàÈÖçÁΩÆ
- `docker-compose.monitoring.yml` - ÁÆÄÂåñÁõëÊéßÊ†à
- `.env.monitoring` - Grafana Cloud ÁéØÂ¢ÉÂèòÈáè

#### 2. Python SDK Êñá‰ª∂

- `apps/backend/shared/telemetry/complete_stack.py` - Áªü‰∏ÄÁõëÊéß SDK
- `apps/backend/shared/telemetry/middleware.py` - FastAPI ‰∏≠Èó¥‰ª∂
- `apps/backend/shared/telemetry/metrics.py` - Ê†∏ÂøÉÊåáÊ†áÂÆö‰πâ

#### 3. Âü∫Á°ÄËÆæÊñΩÊñá‰ª∂

- `infra/monitoring.tf` - Terraform Grafana Cloud ÈõÜÊàê
- Êõ¥Êñ∞ `infra/ecs.tf` - ECS ‰ªªÂä°ÁéØÂ¢ÉÂèòÈáè

## ËøΩË∏™Ê†áËØÜÁ¨¶ (Track ID) ÁÆ°ÁêÜ

### üÜî **Track ID ÁîüÊàê‰∏é‰º†Êí≠**

ÊâÄÊúâ API ËØ∑Ê±ÇÂíåÊúçÂä°Ë∞ÉÁî®ÈÉΩÂøÖÈ°ªÂåÖÂê´ `track_id` Áî®‰∫éÂàÜÂ∏ÉÂºèËøΩË∏™Ôºö

#### A. Tracking ID ‰º†ÈÄíÁ≠ñÁï•

**1. HTTP Header Ê†áÂáÜ**

- **Header ÂêçÁß∞**: `X-Tracking-ID` (Áªü‰∏Ä‰ΩøÁî® Tracking ËÄåÈùû Trace)
- **Ê†ºÂºèËßÑËåÉ**: UUID v4 Ê†ºÂºè (‰æã: `f47ac10b-58cc-4372-a567-0e02b2c3d479`)
- **Â≠óÁ¨¶ÁºñÁ†Å**: UTF-8, ÈïøÂ∫¶Âõ∫ÂÆö 36 Â≠óÁ¨¶

**2. ‰º†ÈÄíËßÑÂàô**

```python
# Âú® TracingMiddleware ‰∏≠ÂÆûÁé∞‰∏âÁ∫ßÁ≠ñÁï•
def _extract_or_generate_tracking_id(self, request: Request) -> str:
    # 1. ‰ºòÂÖà‰ªéËØ∑Ê±ÇÂ§¥ÊèêÂèñ (ÁªßÁª≠‰ΩøÁî®Áé∞Êúâ ID)
    tracking_id = request.headers.get("X-Tracking-ID")
    if tracking_id and self._is_valid_uuid(tracking_id):
        return tracking_id

    # 2. ‰ªé OpenTelemetry ‰∏ä‰∏ãÊñáÊèêÂèñ
    context = propagate.extract(dict(request.headers))
    span_context = trace.get_current_span(context).get_span_context()
    if span_context.is_valid:
        return f"{span_context.trace_id:032x}"

    # 3. Gateway ÁîüÊàêÊñ∞ÁöÑ UUID v4
    return str(uuid.uuid4())

def _is_valid_uuid(self, uuid_string: str) -> bool:
    """È™åËØÅ UUID v4 Ê†ºÂºè"""
    try:
        uuid_obj = uuid.UUID(uuid_string, version=4)
        return str(uuid_obj) == uuid_string
    except ValueError:
        return False
```

**3. ÊúçÂä°Èó¥Ë∞ÉÁî®Ë¶ÅÊ±Ç**

- ‚úÖ **ÂøÖÈ°ªÊê∫Â∏¶**: ÊâÄÊúâÂÜÖÈÉ®ÊúçÂä°Ë∞ÉÁî®ÂøÖÈ°ªÂåÖÂê´ `X-Tracking-ID` Â§¥
- ‚úÖ **Ê†ºÂºèÈ™åËØÅ**: Êé•Êî∂Á´ØÈ™åËØÅ UUID v4 Ê†ºÂºèÔºåÊó†ÊïàÊó∂ÁîüÊàêÊñ∞ ID
- ‚úÖ **ÂìçÂ∫îËøîÂõû**: ÊâÄÊúâ HTTP ÂìçÂ∫îÂøÖÈ°ªËøîÂõû `X-Tracking-ID` Â§¥
- ‚úÖ **Êó•ÂøóËÆ∞ÂΩï**: ÊØè‰∏™ÊúçÂä°ËÆ∞ÂΩïÊé•Êî∂ÂíåÂèëÈÄÅÁöÑ tracking_id

#### Track ID ‰º†Êí≠Êú∫Âà∂

- **HTTP Â§¥ÈÉ®**: `X-Tracking-ID` Âú®ÊâÄÊúâÊúçÂä°Èó¥‰º†ÈÄí
- **ÂìçÂ∫îÂ§¥**: ËøîÂõû `X-Tracking-ID` ‰æø‰∫éÂÆ¢Êà∑Á´ØËøΩË∏™
- **Êó•ÂøóÂÖ≥ËÅî**: ÊâÄÊúâÊó•ÂøóËá™Âä®ÂåÖÂê´ `tracking_id` Â≠óÊÆµ
- **Êï∞ÊçÆÂ∫ìËÆ∞ÂΩï**: ‰∏öÂä°Êï∞ÊçÆÂÖ≥ËÅî `tracking_id` ‰æø‰∫éÈóÆÈ¢òÂÆö‰Ωç

### üìä **ÊØè‰∏™ API ÁöÑ Track ID ÂÆûÁé∞**

#### API Gateway ‚Üí Workflow Agent

```python
# API Gateway ÂèëËµ∑ËØ∑Ê±ÇÊó∂‰º†ÈÄí tracking_id
async def call_workflow_agent(tracking_id: str, payload: dict):
    headers = {"X-Tracking-ID": tracking_id}
    response = await httpx.post(
        f"{WORKFLOW_AGENT_URL}/generate-workflow",
        headers=headers,
        json=payload
    )
```

#### API Gateway ‚Üí Workflow Engine

```python
# ÊâßË°åÂ∑•‰ΩúÊµÅÊó∂‰º†ÈÄí tracking_id
async def execute_workflow(tracking_id: str, workflow_data: dict):
    headers = {"X-Tracking-ID": tracking_id}
    response = await httpx.post(
        f"{WORKFLOW_ENGINE_URL}/execute",
        headers=headers,
        json=workflow_data
    )
```

#### ‰∏≠Èó¥‰ª∂Ëá™Âä®Â§ÑÁêÜ

```python
# TracingMiddleware Ëá™Âä®Â§ÑÁêÜÊâÄÊúâËØ∑Ê±Ç
class TracingMiddleware(BaseHTTPMiddleware):
    async def dispatch(self, request: Request, call_next):
        # ÊèêÂèñÊàñÁîüÊàê tracking_id
        tracking_id = self._extract_or_generate_tracking_id(request)

        # Â≠òÂÇ®Âú®ËØ∑Ê±ÇÁä∂ÊÄÅ‰∏≠
        request.state.tracking_id = tracking_id

        # Â§ÑÁêÜËØ∑Ê±Ç
        with self.tracer.start_as_current_span(span_name) as span:
            span.set_attribute("tracking.id", tracking_id)
            response = await call_next(request)

            # Ê∑ªÂä†Âà∞ÂìçÂ∫îÂ§¥
            response.headers["X-Tracking-ID"] = tracking_id
            return response
```

## C. Êó•ÂøóÂÖ≥ËÅîËßÑËåÉ

### üìù **1. ÁªìÊûÑÂåñÊó•ÂøóË¶ÅÊ±Ç**

ÊâÄÊúâÊúçÂä°ÂøÖÈ°ª‰ΩøÁî® **JSON Ê†ºÂºè** ÁöÑÁªìÊûÑÂåñÊó•ÂøóÔºå**ÂÆåÂÖ®ÈÄÇÈÖç AWS CloudWatch Logs**Ôºö

```python
# AWS CloudWatch ‰ºòÂåñÁöÑÊó•ÂøóÊ†ºÂºè
{
    "timestamp": "2025-01-31T10:30:45.123Z",
    "@timestamp": "2025-01-31T10:30:45.123Z",  # CloudWatch Ëá™Âä®Ëß£Êûê
    "level": "INFO",
    "@level": "INFO",  # CloudWatch Êó•ÂøóÁ∫ßÂà´Â≠óÊÆµ
    "service": "api-gateway",
    "tracking_id": "f47ac10b-58cc-4372-a567-0e02b2c3d479",
    "message": "POST /api/v1/sessions - 201",
    "@message": "POST /api/v1/sessions - 201",  # CloudWatch Ê∂àÊÅØÂ≠óÊÆµ
    "request": {  # ÂµåÂ•óÂØπË±°ÊîØÊåÅÁÇπÂè∑Êü•ËØ¢
        "method": "POST",
        "path": "/api/v1/sessions",
        "duration": 0.245,
        "size": 1024
    },
    "response": {
        "status": 201,
        "size": 2048
    },
    "user": {
        "id": "user_12345",
        "segment": "premium"
    },
    "session": {
        "id": "session_67890"
    },
    "tracing": {
        "span_id": "1a2b3c4d5e6f7890",
        "trace_id": "f47ac10b58cc4372a5670e02b2c3d479"
    }
}
```

### üîç **CloudWatch Logs Insights Êü•ËØ¢‰ºòÂåñ**

**ÂµåÂ•óÂ≠óÊÆµÊü•ËØ¢ (ÁÇπÂè∑Ë°®Á§∫Ê≥ï)**Ôºö

```sql
# Êü•ËØ¢ÁâπÂÆöÁî®Êà∑ÁöÑÈîôËØØËØ∑Ê±Ç
fields @timestamp, message, request.method, response.status
| filter user.id = "user_12345" and response.status >= 400
| sort @timestamp desc

# ÊåâÊúçÂä°ÂíåÁ´ØÁÇπÂàÜÁªÑÁªüËÆ°
fields @timestamp, service, request.path, request.duration
| filter request.duration > 1.0
| stats count() by service, request.path
```

### üè∑Ô∏è **CloudWatch Â≠óÊÆµÁ¥¢Âºï‰ºòÂåñ**

**Á¥¢ÂºïÂ≠óÊÆµ (ÊèêÂçáÊü•ËØ¢ÊÄßËÉΩ)**Ôºö

- `@timestamp` - Ëá™Âä®Á¥¢ÂºïÊó∂Èó¥Â≠óÊÆµ
- `@level` - Êó•ÂøóÁ∫ßÂà´Á¥¢Âºï
- `@message` - Ê∂àÊÅØÂÜÖÂÆπÁ¥¢Âºï
- `tracking_id` - ËøΩË∏™ ID Á¥¢Âºï
- `service` - ÊúçÂä°ÂêçÁ¥¢Âºï
- `request.method` - HTTP ÊñπÊ≥ïÁ¥¢Âºï
- `response.status` - Áä∂ÊÄÅÁ†ÅÁ¥¢Âºï

### üîó **2. Tracking ID ÂøÖÈ°ªÂåÖÂê´**

**ÊâÄÊúâÊó•ÂøóËÆ∞ÂΩïÂøÖÈ°ªÂåÖÂê´ `tracking_id` Â≠óÊÆµ**Ôºö

```python
# CloudWatch ‰ºòÂåñÁöÑ TracingFormatter
class CloudWatchTracingFormatter(logging.Formatter):
    def format(self, record: logging.LogRecord) -> str:
        # Ëé∑ÂèñÂΩìÂâçËØ∑Ê±ÇÁöÑ tracking_id
        tracking_id = getattr(record, 'tracking_id', None)
        if not tracking_id:
            tracking_id = getattr(current_request.state, 'tracking_id', 'unknown')

        timestamp = datetime.utcnow().isoformat() + "Z"

        # CloudWatch ‰ºòÂåñÊ†ºÂºè
        log_entry = {
            "timestamp": timestamp,
            "@timestamp": timestamp,  # CloudWatch Ëá™Âä®Ëß£Êûê
            "level": record.levelname,
            "@level": record.levelname,  # CloudWatch Êó•ÂøóÁ∫ßÂà´
            "service": self.service_name,
            "tracking_id": tracking_id,
            "message": record.getMessage(),
            "@message": record.getMessage(),  # CloudWatch Ê∂àÊÅØÂ≠óÊÆµ
            "source": {
                "module": record.module,
                "function": record.funcName,
                "line": record.lineno
            }
        }

        # ÁªìÊûÑÂåñÈ¢ùÂ§ñÂ≠óÊÆµ
        extra_fields = {}
        for key, value in record.__dict__.items():
            if key not in EXCLUDED_FIELDS:
                extra_fields[key] = value

        # ÊåâÁ±ªÂûãÂàÜÁªÑÂ≠óÊÆµÔºå‰æø‰∫é CloudWatch Êü•ËØ¢
        if 'request_method' in extra_fields:
            log_entry['request'] = {
                'method': extra_fields.get('request_method'),
                'path': extra_fields.get('request_path'),
                'duration': extra_fields.get('request_duration'),
                'size': extra_fields.get('request_size')
            }

        if 'response_status' in extra_fields:
            log_entry['response'] = {
                'status': extra_fields.get('response_status'),
                'size': extra_fields.get('response_size')
            }

        if 'user_id' in extra_fields:
            log_entry['user'] = {
                'id': extra_fields.get('user_id'),
                'segment': extra_fields.get('user_segment')
            }

        if 'session_id' in extra_fields:
            log_entry['session'] = {
                'id': extra_fields.get('session_id'),
                'duration': extra_fields.get('session_duration')
            }

        return json.dumps(log_entry, ensure_ascii=False, separators=(',', ':'))
```

### ‚ö†Ô∏è **3. ERROR Á∫ßÂà´Ëá™Âä®ÂàõÂª∫ Span Events**

**ÊâÄÊúâ ERROR Êó•ÂøóËá™Âä®Âú® OpenTelemetry Span ‰∏≠ÂàõÂª∫‰∫ã‰ª∂**Ôºö

```python
class TracingFormatter(logging.Formatter):
    def format(self, record: logging.LogRecord) -> str:
        # ... Âü∫Á°ÄÊ†ºÂºèÂåñ ...

        # ERROR Á∫ßÂà´Ëá™Âä®ÂàõÂª∫ span event
        if record.levelno >= logging.ERROR:
            span = trace.get_current_span()
            if span and span.get_span_context().is_valid:

                # ËÆ∞ÂΩïÂºÇÂ∏∏‰ø°ÊÅØ
                if record.exc_info:
                    exception = record.exc_info[1]
                    span.record_exception(exception)
                    span.set_status(Status(StatusCode.ERROR, record.getMessage()))

                # ÂàõÂª∫ÈîôËØØ‰∫ã‰ª∂
                span.add_event(
                    name="error_log",
                    attributes={
                        "log.level": record.levelname,
                        "log.message": record.getMessage(),
                        "log.logger": record.name,
                        "log.module": record.module,
                        "log.function": record.funcName,
                        "log.line": record.lineno,
                        "tracking.id": log_entry["tracking_id"],
                        "error.type": type(exception).__name__ if record.exc_info else "UnknownError"
                    },
                    timestamp=time.time_ns()
                )

        return json.dumps(log_entry, ensure_ascii=False)
```

### üîç **4. ÂÖ≥ËÅîÊú∫Âà∂ÂÆûÁé∞**

#### Êó•Âøó-ËøΩË∏™ÂÖ≥ËÅî

```python
# ËØ∑Ê±ÇÊó•ÂøóËá™Âä®ÂåÖÂê´ tracking_id
logger.info(
    f"{method} {path} - {status_code}",
    extra={
        "tracking_id": getattr(request.state, 'tracking_id', None),
        "request_method": method,
        "request_path": path,
        "response_status": status_code,
        "request_duration": duration,
        "user_id": getattr(request.state, 'user_id', None),
        "session_id": getattr(request.state, 'session_id', None)
    }
)
```

#### Êï∞ÊçÆÂ∫ìÊìç‰ΩúÂÖ≥ËÅî

```python
# ‰∏öÂä°Êï∞ÊçÆÂøÖÈ°ªÂåÖÂê´ tracking_id
async def create_workflow_session(tracking_id: str, user_id: str):
    session_data = {
        "id": str(uuid.uuid4()),
        "user_id": user_id,
        "tracking_id": tracking_id,  # ÂøÖÈúÄÂ≠óÊÆµ
        "created_at": datetime.utcnow(),
        "status": "active"
    }

    # Êó•ÂøóËÆ∞ÂΩïÂåÖÂê´Áõ∏Âêå tracking_id
    logger.info(
        f"Created workflow session for user {user_id}",
        extra={
            "tracking_id": tracking_id,
            "session_id": session_data["id"],
            "user_id": user_id,
            "operation": "create_session"
        }
    )

    await db.sessions.insert(session_data)
```

#### Span Â±ûÊÄßÂÖ≥ËÅî

```python
# OpenTelemetry Span ÂøÖÈ°ªÂåÖÂê´ tracking_id
span.set_attributes({
    "tracking.id": tracking_id,
    "service.name": service_name,
    "operation.name": operation_name,
    "user.id": user_id,
    "session.id": session_id,
    "request.method": method,
    "request.path": path,
    "request.size": request_size,
    "response.size": response_size
})
```

### üìã **5. CloudWatch Êó•ÂøóÂ≠óÊÆµÊ†áÂáÜ**

#### ÂøÖÈúÄÂ≠óÊÆµ (ÊâÄÊúâÊó•Âøó)

```json
{
  "timestamp": "2025-01-31T10:30:45.123Z",
  "@timestamp": "2025-01-31T10:30:45.123Z",
  "level": "INFO|WARN|ERROR|DEBUG",
  "@level": "INFO|WARN|ERROR|DEBUG",
  "service": "api-gateway|workflow-agent|workflow-engine",
  "tracking_id": "f47ac10b-58cc-4372-a567-0e02b2c3d479",
  "message": "Human readable message",
  "@message": "Human readable message"
}
```

#### HTTP ËØ∑Ê±ÇÁªìÊûÑ (ÂµåÂ•óÂØπË±°)

```json
{
  "request": {
    "method": "GET|POST|PUT|DELETE",
    "path": "/api/v1/sessions",
    "size": 1024,
    "duration": 0.245,
    "user_agent": "Mozilla/5.0...",
    "ip": "192.168.1.100"
  },
  "response": {
    "status": 200,
    "size": 2048,
    "content_type": "application/json"
  }
}
```

#### ‰∏öÂä°Êìç‰ΩúÁªìÊûÑ

```json
{
  "user": {
    "id": "user_12345",
    "segment": "premium|free|enterprise"
  },
  "session": {
    "id": "session_67890",
    "duration": 1200
  },
  "workflow": {
    "id": "workflow_abc123",
    "type": "simple|complex|ai-assisted",
    "status": "running|completed|failed"
  },
  "operation": {
    "name": "create_session|execute_workflow|generate_response",
    "result": "success|failure|partial",
    "duration": 0.325
  }
}
```

#### ÈîôËØØÁªìÊûÑ (ERROR Á∫ßÂà´)

```json
{
  "error": {
    "type": "ValidationError|BusinessLogicError|SystemError",
    "code": "E001|E002|E003",
    "message": "Detailed error description",
    "category": "client|server|network|timeout"
  },
  "exception": {
    "class": "ValueError",
    "stack_trace": "Full stack trace for debugging",
    "file": "app/handlers/session.py",
    "line": 42
  }
}
```

### üí∞ **ÊàêÊú¨‰ºòÂåñÈÖçÁΩÆ**

**Â≠óÊÆµÊï∞ÈáèÈôêÂà∂ (CloudWatch ÊúÄÂ§ö 1000 Â≠óÊÆµ)**Ôºö

```python
class CloudWatchFormatter:
    MAX_FIELDS = 900  # ‰øùÁïô 100 Â≠óÊÆµ‰ΩôÈáè

    def _limit_fields(self, log_entry: dict) -> dict:
        """ÈôêÂà∂Â≠óÊÆµÊï∞ÈáèÔºåÈÅøÂÖç CloudWatch Êà™Êñ≠"""
        if self._count_fields(log_entry) > self.MAX_FIELDS:
            # ‰øùÁïôÊ†∏ÂøÉÂ≠óÊÆµÔºåÁßªÈô§ËØ¶ÁªÜÂ≠óÊÆµ
            return self._keep_essential_fields(log_entry)
        return log_entry
```

**Êó•ÂøóÁ∫ßÂà´ËøáÊª§ (ÂáèÂ∞ëÂ≠òÂÇ®ÊàêÊú¨)**Ôºö

```yaml
# Áîü‰∫ßÁéØÂ¢ÉÈÖçÁΩÆ
production:
  log_level: "WARN" # Âè™ËÆ∞ÂΩï WARN Âíå ERROR

# ÂºÄÂèëÁéØÂ¢ÉÈÖçÁΩÆ
development:
  log_level: "DEBUG" # ËÆ∞ÂΩïÊâÄÊúâÁ∫ßÂà´
```

## Ê†∏ÂøÉÈÖçÁΩÆÊ®°Êùø

### OTel Collector Ê∑∑ÂêàÈÖçÁΩÆ

`monitoring/otel-collector-config.yml`

```yaml
receivers:
  otlp:
    protocols:
      grpc: { endpoint: 0.0.0.0:4317 }
      http: { endpoint: 0.0.0.0:4318 }

processors:
  resource:
    attributes:
      - key: deployment.environment
        value: "${ENVIRONMENT}"
        action: upsert
  memory_limiter: { limit_mib: 512 }
  batch: { timeout: 1s }

exporters:
  # Êú¨Âú∞ Jaeger
  jaeger:
    endpoint: jaeger:14250
    tls: { insecure: true }

  # Êú¨Âú∞ Prometheus
  prometheus:
    endpoint: "0.0.0.0:8888"
    const_labels:
      environment: "${ENVIRONMENT}"
      project: "ai-teams-monorepo"

  # Grafana Cloud Mimir
  prometheusremotewrite/grafana-cloud:
    endpoint: "${GRAFANA_CLOUD_PROMETHEUS_URL}"
    headers:
      authorization: "Bearer ${GRAFANA_CLOUD_TENANT_ID}:${GRAFANA_CLOUD_API_KEY}"
    external_labels:
      environment: "${ENVIRONMENT}"
      project: "ai-teams-monorepo"

  # Grafana Cloud Loki
  loki/grafana-cloud:
    endpoint: "${GRAFANA_CLOUD_LOKI_URL}"
    headers:
      authorization: "Bearer ${GRAFANA_CLOUD_TENANT_ID}:${GRAFANA_CLOUD_API_KEY}"

service:
  pipelines:
    traces:
      receivers: [otlp]
      processors: [memory_limiter, resource, batch]
      exporters: [jaeger]
    metrics:
      receivers: [otlp]
      processors: [memory_limiter, resource, batch]
      exporters: [prometheus, prometheusremotewrite/grafana-cloud]
    logs:
      receivers: [otlp]
      processors: [memory_limiter, resource, batch]
      exporters: [loki/grafana-cloud]
```

### ÁÆÄÂåñ Docker Compose

`docker-compose.monitoring.yml`

```yaml
version: "3.8"
services:
  otel-collector:
    image: otel/opentelemetry-collector-contrib:latest
    volumes:
      - ./monitoring/otel-collector-config.yml:/etc/otel-collector-config.yml:ro
    ports:
      - "4317:4317" # OTLP gRPC
      - "4318:4318" # OTLP HTTP
      - "8888:8888" # Prometheus
    environment:
      - ENVIRONMENT=${ENVIRONMENT:-dev}
      - GRAFANA_CLOUD_API_KEY=${GRAFANA_CLOUD_API_KEY}
      - GRAFANA_CLOUD_PROMETHEUS_URL=${GRAFANA_CLOUD_PROMETHEUS_URL}
      - GRAFANA_CLOUD_LOKI_URL=${GRAFANA_CLOUD_LOKI_URL}
      - GRAFANA_CLOUD_TENANT_ID=${GRAFANA_CLOUD_TENANT_ID}

  jaeger:
    image: jaegertracing/all-in-one:latest
    ports: ["16686:16686", "14250:14250"]
    environment: [COLLECTOR_OTLP_ENABLED=true]

  prometheus:
    image: prom/prometheus:latest
    ports: ["9090:9090"]
    volumes:
      - ./monitoring/prometheus.yml:/etc/prometheus/prometheus.yml:ro
    command:
      - "--config.file=/etc/prometheus/prometheus.yml"
      - "--storage.tsdb.retention.time=7d"
```

### ÁéØÂ¢ÉÂèòÈáèÈÖçÁΩÆ

`.env.monitoring`

```bash
# ÂºÄÂèëÁéØÂ¢É
ENVIRONMENT=dev
GRAFANA_CLOUD_API_KEY=glc_eyJrIjoixxxxxxxx
GRAFANA_CLOUD_PROMETHEUS_URL=https://prometheus-prod-01-eu-west-0.grafana.net/api/prom/push
GRAFANA_CLOUD_LOKI_URL=https://logs-prod-006.grafana.net/loki/api/v1/push
GRAFANA_CLOUD_TENANT_ID=123456

# Áîü‰∫ßÁéØÂ¢ÉÔºö‰ΩøÁî®Áõ∏Âêå API KeyÔºåÈÄöËøá environment Ê†áÁ≠æÂå∫ÂàÜ
```

## Terraform Âü∫Á°ÄËÆæÊñΩÊõ¥Êñ∞

### Êñ∞Â¢û Grafana Cloud ÈõÜÊàê

`infra/monitoring.tf`

```hcl
variable "grafana_cloud_api_key" {
  description = "Grafana Cloud API Key"
  type        = string
  sensitive   = true
}

resource "aws_ssm_parameter" "grafana_cloud_api_key" {
  name  = "/ai-teams/${var.environment}/monitoring/grafana-cloud-api-key"
  type  = "SecureString"
  value = var.grafana_cloud_api_key
}

resource "aws_ssm_parameter" "grafana_cloud_config" {
  name = "/ai-teams/${var.environment}/monitoring/grafana-cloud-config"
  type = "String"
  value = jsonencode({
    tenant_id     = var.grafana_cloud_tenant_id
    prometheus_url = "https://prometheus-prod-01-eu-west-0.grafana.net/api/prom/push"
    loki_url      = "https://logs-prod-006.grafana.net/loki/api/v1/push"
  })
}
```

### Êõ¥Êñ∞ ECS ‰ªªÂä°ÂÆö‰πâ

`infra/ecs.tf` - Ê∑ªÂä† OTel Collector ÁéØÂ¢ÉÂèòÈáè

```hcl
resource "aws_ecs_task_definition" "otel_collector" {
  family = "ai-teams-otel-collector-${var.environment}"
  container_definitions = jsonencode([{
    name  = "otel-collector"
    image = "otel/opentelemetry-collector-contrib:latest"
    environment = [
      { name = "ENVIRONMENT", value = var.environment }
    ]
    secrets = [
      { name = "GRAFANA_CLOUD_API_KEY", valueFrom = aws_ssm_parameter.grafana_cloud_api_key.arn }
    ]
  }])
}
```

## ÂÆûÊñΩÊ≠•È™§

### Èò∂ÊÆµ 1: ÁéØÂ¢ÉÂáÜÂ§á (30 ÂàÜÈíü)

1. **Ê≥®ÂÜå Grafana Cloud ÂÖçË¥πË¥¶Âè∑**

   - Ëé∑Âèñ API Key Âíå Tenant ID
   - ÈÖçÁΩÆ Prometheus + Loki Á´ØÁÇπ

2. **ÂàõÂª∫ÁõëÊéßÁõÆÂΩïÁªìÊûÑ**
   ```bash
   mkdir -p monitoring
   mkdir -p apps/backend/shared/telemetry
   ```

### Èò∂ÊÆµ 2: ÈÖçÁΩÆÊñá‰ª∂ÈÉ®ÁΩ≤ (1 Â∞èÊó∂)

1. **ÂàõÂª∫‰∏äËø∞Ê®°ÊùøÊñá‰ª∂**

   - `monitoring/otel-collector-config.yml`
   - `docker-compose.monitoring.yml`
   - `.env.monitoring`

2. **ÂêØÂä®ÁõëÊéßÊ†à**
   ```bash
   docker-compose -f docker-compose.monitoring.yml up -d
   ```

### Èò∂ÊÆµ 3: Â∫îÁî®ÈõÜÊàê (2 Â∞èÊó∂)

1. **ÂÆâË£Ö‰æùËµñ**

   ```bash
   pip install opentelemetry-api opentelemetry-sdk opentelemetry-instrumentation-fastapi
   ```

2. **ÂàõÂª∫ÈõÜÊàê‰ª£Á†Å**

   - `apps/backend/shared/telemetry/complete_stack.py` - Áªü‰∏Ä SDK
   - Êõ¥Êñ∞ÂêÑÊúçÂä° `main.py` Ê∑ªÂä†‰∏≠Èó¥‰ª∂

3. **È™åËØÅÊï∞ÊçÆÊµÅ**
   - Jaeger UI: http://localhost:16686
   - Prometheus: http://localhost:9090
   - Grafana Cloud: ÁôªÂΩïÊü•ÁúãÊåáÊ†á

### Èò∂ÊÆµ 4: Âü∫Á°ÄËÆæÊñΩÊõ¥Êñ∞ (1 Â∞èÊó∂)

1. **Êõ¥Êñ∞ Terraform ÈÖçÁΩÆ**

   - Ê∑ªÂä† `infra/monitoring.tf`
   - Êõ¥Êñ∞ `infra/ecs.tf` ÁéØÂ¢ÉÂèòÈáè

2. **ÈÉ®ÁΩ≤Âà∞ AWS**
   ```bash
   cd infra
   terraform plan -var="grafana_cloud_api_key=$API_KEY"
   terraform apply
   ```

## ÊàêÊú¨ÂàÜÊûê

### ÂÖçË¥πÂ±ÇÈôêÂà∂

- **Grafana Cloud**: 5 Áî®Êà∑, 10K metrics, 50GB Êó•Âøó/Êúà
- **AWS**: ~$60-110/Êúà (vs ÂÖ®Êú¨Âú∞ $200-400/Êúà)

### Êâ©Â±ïÊàêÊú¨

- **Áî®Êà∑ 100+**: Grafana Pro $29/Êúà
- **Áî®Êà∑ 1000+**: Grafana Advanced $299/Êúà

## B. Metrics Êî∂ÈõÜÁ≠ñÁï•

### üìä **1. Âü∫Á°ÄÊåáÊ†á (Infrastructure Metrics)**

ÊâÄÊúâÊúçÂä°ÂøÖÈ°ªÊî∂ÈõÜÁöÑÊ†∏ÂøÉÊÄßËÉΩÊåáÊ†áÔºö

```python
# HTTP ËØ∑Ê±ÇÊåáÊ†á
request_count = Counter(
    'request_count',
    'Total number of HTTP requests',
    ['service_name', 'endpoint', 'method', 'status_code', 'api_version']
)

request_duration = Histogram(
    'request_duration_seconds',
    'HTTP request duration in seconds',
    ['service_name', 'endpoint', 'method'],
    buckets=[0.005, 0.01, 0.025, 0.05, 0.1, 0.25, 0.5, 1, 2.5, 5, 10]
)

request_errors = Counter(
    'request_errors_total',
    'Total number of HTTP request errors',
    ['service_name', 'endpoint', 'method', 'error_type', 'status_code']
)

active_requests = Gauge(
    'active_requests',
    'Number of active HTTP requests',
    ['service_name', 'endpoint']
)
```

### üè¢ **2. ‰∏öÂä°ÊåáÊ†á (Business Metrics)**

‰∏öÂä°Â±ÇÈù¢ÁöÑÂÖ≥ÈîÆÊåáÊ†áÔºö

```python
# API ‰ΩøÁî®ÊÉÖÂÜµ
api_key_usage = Counter(
    'api_key_usage_total',
    'API key usage by client',
    ['api_key_id', 'client_name', 'service_name', 'endpoint', 'success']
)

endpoint_usage = Counter(
    'endpoint_usage_total',
    'Endpoint usage frequency',
    ['service_name', 'endpoint', 'api_version', 'user_segment']
)

user_activity = Counter(
    'user_activity_total',
    'User activity events',
    ['user_id', 'activity_type', 'service_name', 'session_id']
)

# ‰∏öÂä°ÊàêÂäüÁéá
workflow_success_rate = Histogram(
    'workflow_success_rate',
    'Workflow execution success rate',
    ['workflow_type', 'complexity_level'],
    buckets=[0.0, 0.5, 0.7, 0.8, 0.9, 0.95, 0.99, 1.0]
)
```

### üè∑Ô∏è **3. Ê†áÁ≠æÁª¥Â∫¶ (Label Dimensions)**

ÊâÄÊúâÊåáÊ†áÂøÖÈ°ªÂåÖÂê´ÁöÑÊ†áÂáÜÂåñÊ†áÁ≠æÔºö

#### Ê†∏ÂøÉÊ†áÁ≠æ (ÊâÄÊúâÊåáÊ†áÂøÖÈúÄ)

```yaml
service_name: # "api-gateway" | "workflow-agent" | "workflow-engine"
environment: # "dev" | "staging" | "prod"
version: # API ÁâàÊú¨Âè∑ "v1" | "v2"
tracking_id: # UUID v4 Ê†ºÂºèÁöÑËøΩË∏™ ID
```

#### HTTP ËØ∑Ê±ÇÊ†áÁ≠æ

```yaml
endpoint: # Ê†áÂáÜÂåñÁ´ØÁÇπ "/api/v1/sessions/{id}"
method: # HTTP ÊñπÊ≥ï "GET" | "POST" | "PUT" | "DELETE"
status_code: # HTTP Áä∂ÊÄÅÁ†Å "200" | "400" | "500"
api_version: # API ÁâàÊú¨ "v1" | "v2"
user_agent: # ÂÆ¢Êà∑Á´ØÁ±ªÂûã "web" | "mobile" | "mcp-client"
```

#### ‰∏öÂä°ÊåáÊ†áÊ†áÁ≠æ

```yaml
user_segment: # Áî®Êà∑ÂàÜÁªÑ "free" | "premium" | "enterprise"
client_type: # ÂÆ¢Êà∑Á´ØÁ±ªÂûã "web-app" | "mobile-app" | "api-client"
workflow_type: # Â∑•‰ΩúÊµÅÁ±ªÂûã "simple" | "complex" | "ai-assisted"
error_category: # ÈîôËØØÂàÜÁ±ª "validation" | "business" | "system"
```

### üìà **ÊåáÊ†áÊî∂ÈõÜÂÆûÁé∞**

```python
# Âú® MetricsMiddleware ‰∏≠ÂÆûÁé∞
class MetricsMiddleware(BaseHTTPMiddleware):
    async def dispatch(self, request: Request, call_next):
        start_time = time.time()
        tracking_id = getattr(request.state, 'tracking_id', 'unknown')

        # Â¢ûÂä†Ê¥ªË∑ÉËØ∑Ê±Ç
        active_requests.labels(
            service_name=self.service_name,
            endpoint=self._normalize_endpoint(request.url.path)
        ).inc()

        try:
            response = await call_next(request)

            # ËÆ∞ÂΩïÊàêÂäüËØ∑Ê±Ç
            duration = time.time() - start_time
            labels = {
                'service_name': self.service_name,
                'endpoint': self._normalize_endpoint(request.url.path),
                'method': request.method,
                'status_code': str(response.status_code),
                'api_version': self._extract_api_version(request.url.path),
                'tracking_id': tracking_id
            }

            request_count.labels(**labels).inc()
            request_duration.labels(
                service_name=labels['service_name'],
                endpoint=labels['endpoint'],
                method=labels['method']
            ).observe(duration)

            return response

        except Exception as e:
            # ËÆ∞ÂΩïÈîôËØØ
            request_errors.labels(
                service_name=self.service_name,
                endpoint=self._normalize_endpoint(request.url.path),
                method=request.method,
                error_type=type(e).__name__,
                status_code="500"
            ).inc()
            raise

        finally:
            # ÂáèÂ∞ëÊ¥ªË∑ÉËØ∑Ê±Ç
            active_requests.labels(
                service_name=self.service_name,
                endpoint=self._normalize_endpoint(request.url.path)
            ).dec()
```

## Ê†∏ÂøÉÊåáÊ†áÂÆö‰πâ

### HTTP Âü∫Á°ÄÊåáÊ†á

- `request_count{service_name, endpoint, method, status_code, api_version, tracking_id}`
- `request_duration_seconds{service_name, endpoint, method}`
- `request_errors_total{service_name, endpoint, method, error_type, status_code}`
- `active_requests{service_name, endpoint}`

### AI ‰∏ìÈ°πÊåáÊ†á

- `ai_requests_total{model, provider, environment, tracking_id}`
- `ai_tokens_total{model, token_type, environment, tracking_id}`
- `ai_cost_total{model, environment, tracking_id}`

### ‰∏öÂä°ÊåáÊ†á

- `api_key_usage_total{api_key_id, client_name, service_name, endpoint, success}`
- `endpoint_usage_total{service_name, endpoint, api_version, user_segment}`
- `user_activity_total{user_id, activity_type, service_name, session_id}`
- `workflow_success_rate{workflow_type, complexity_level}`

## È™åÊî∂Ê†áÂáÜ

### ‚úÖ ÂÆåÊàêÊ£ÄÊü•È°π

1. [ ] Jaeger UI ÊòæÁ§∫ÊúçÂä°Èó¥Ë∞ÉÁî®Èìæ
2. [ ] Prometheus Êî∂ÈõÜÂà∞Â∫îÁî®ÊåáÊ†á
3. [ ] Grafana Cloud ÊòæÁ§∫ dev/prod ÂàÜÁ¶ªÊï∞ÊçÆ
4. [ ] Êó•ÂøóÂåÖÂê´ trace_id ÂÖ≥ËÅî
5. [ ] ÂëäË≠¶ËßÑÂàôÊ≠£Â∏∏Ëß¶Âèë
6. [ ] ÊàêÊú¨ÊéßÂà∂Âú®È¢ÑÁÆóÂÜÖ
7. [ ] **ÊØè‰∏™ API ËØ∑Ê±ÇÈÉΩÊúâ tracking_id (UUID v4 Ê†ºÂºè)**
8. [ ] **ÊúçÂä°Èó¥Ë∞ÉÁî®Ê≠£Á°Æ‰º†ÈÄí X-Tracking-ID Â§¥**
9. [ ] **ÂìçÂ∫îÂ§¥ÂåÖÂê´ X-Tracking-ID ‰æø‰∫éÂÆ¢Êà∑Á´ØËøΩË∏™**
10. [ ] **Êï∞ÊçÆÂ∫ìËÆ∞ÂΩïÂÖ≥ËÅî tracking_id Â≠óÊÆµ**
11. [ ] **ÊâÄÊúâÊó•Âøó‰ΩøÁî® JSON ÁªìÊûÑÂåñÊ†ºÂºè (ÂÆåÂÖ®ÈÄÇÈÖç AWS CloudWatch)**
12. [ ] **ÊâÄÊúâÊó•ÂøóÂøÖÈ°ªÂåÖÂê´ tracking_id Â≠óÊÆµ**
13. [ ] **ERROR Á∫ßÂà´Êó•ÂøóËá™Âä®ÂàõÂª∫ OpenTelemetry Span Events**
14. [ ] **Âü∫Á°ÄÊåáÊ†áÂåÖÂê´ÂøÖÈúÄÊ†áÁ≠æÁª¥Â∫¶ (service_name, endpoint, method, status_code, api_version)**
15. [ ] **‰∏öÂä°ÊåáÊ†áÊî∂ÈõÜ (api_key_usage, endpoint_usage, user_activity)**
16. [ ] **CloudWatch Â≠óÊÆµ‰ºòÂåñ (@timestamp, @level, @message Â≠óÊÆµ)**
17. [ ] **ÂµåÂ•óÂØπË±°ÁªìÊûÑÊîØÊåÅÁÇπÂè∑Êü•ËØ¢ (request.method, user.id)**
18. [ ] **Â≠óÊÆµÊï∞ÈáèÈôêÂà∂ (Â∞è‰∫é 1000 Â≠óÊÆµÈÅøÂÖçÊà™Êñ≠)**
19. [ ] **CloudWatch Logs Insights Êü•ËØ¢È™åËØÅ**

### üéØ ÂÖ≥ÈîÆÊàêÂäüÊåáÊ†á

- Á≥ªÁªüÂèØÁî®ÊÄß &gt;99.9%
- ÊåáÊ†áÊî∂ÈõÜÂª∂Ëøü &lt;30 Áßí
- ËøΩË∏™Ë¶ÜÁõñÁéá &gt;95%
- ÊàêÊú¨‰ºòÂåñÊΩúÂäõÂèØËßÅ

---

**ÂÆûÊñΩË¥üË¥£‰∫∫**: ÂàÜÈÖçÁªôÂÖ∑‰ΩìÂºÄÂèëËÄÖ
**È¢ÑËÆ°ÂÆåÊàêÊó∂Èó¥**: 1 ‰∏™Â∑•‰ΩúÊó•
**‰æùËµñÈ°π**: Grafana Cloud Ë¥¶Âè∑, AWS ÊùÉÈôê
