"use client";

import React, { useState, useEffect } from 'react';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Badge } from '@/components/ui/badge';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Textarea } from '@/components/ui/textarea';
import { 
  Mail, 
  Play, 
  CheckCircle, 
  XCircle, 
  AlertCircle,
  Loader2,
  Shield,
  ExternalLink,
  Send,
  AtSign,
  Server,
  Key,
  FileText
} from 'lucide-react';
import { useToast } from '@/hooks/use-toast';

const USER_ID = '7ba36345-a2bb-4ec9-a001-bb46d79d629d';

interface ExecutionResult {
  execution_id: string;
  status: string;
  output_data: any;
  error_message?: string;
  logs: string[];
}

interface EmailFormData {
  to: string;
  cc: string;
  bcc: string;
  subject: string;
  body: string;
  smtpServer: string;
  port: number;
  username: string;
  password: string;
  useTls: boolean;
  contentType: 'text/plain' | 'text/html';
}

export default function EmailTestPage() {
  const [isLoading, setIsLoading] = useState(false);
  const [lastResult, setLastResult] = useState<ExecutionResult | null>(null);
  const [workflowId, setWorkflowId] = useState<string | null>(null);
  const { toast } = useToast();

  const [formData, setFormData] = useState<EmailFormData>({
    to: 'test@example.com',
    cc: '',
    bcc: '',
    subject: 'Test Email from Agent Team',
    body: `<h2>Hello from Agent Team! ğŸ“§</h2>

<p>This is a test email sent through our <strong>external API integration system</strong>.</p>

<h3>Key Features:</h3>
<ul>
  <li>âœ… SMTP Integration</li>
  <li>âœ… HTML Email Support</li>
  <li>âœ… CC/BCC Recipients</li>
  <li>âœ… TLS Encryption</li>
  <li>âœ… Attachment Support</li>
</ul>

<p>Best regards,<br/>
<em>The Agent Team Bot</em> ğŸ¤–</p>

<hr/>
<small>This email was automatically generated by our workflow automation system.</small>`,
    smtpServer: 'smtp.gmail.com',
    port: 587,
    username: 'your-email@gmail.com',
    password: 'your-app-password',
    useTls: true,
    contentType: 'text/html'
  });

  // åˆ›å»ºæµ‹è¯•å·¥ä½œæµ
  const createTestWorkflow = async () => {
    const response = await fetch('http://localhost:8002/v1/workflows', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        user_id: USER_ID,
        name: 'Email SMTP Test',
        description: 'Test workflow for sending emails via SMTP',
        settings: {
          timeout: 300,
          retry_count: 3
        },
        nodes: [{
          id: 'email_send_node',
          name: 'Send Email via SMTP',
          type: 'EXTERNAL_ACTION_NODE',
          subtype: 'EMAIL',
          parameters: {
            to: formData.to.split(',').map(e => e.trim()),
            subject: formData.subject,
            body: formData.body,
            smtp_server: formData.smtpServer,
            username: formData.username,
            password: formData.password
          },
          position: { x: 100, y: 100 }
        }],
        connections: {},
        trigger: {
          type: 'manual',
          config: {}
        }
      })
    });

    if (!response.ok) {
      throw new Error('Failed to create workflow');
    }

    const data = await response.json();
    return data.workflow.id;
  };

  // æ‰§è¡ŒEmailèŠ‚ç‚¹
  const executeEmailNode = async () => {
    try {
      let currentWorkflowId = workflowId;
      if (!currentWorkflowId) {
        currentWorkflowId = await createTestWorkflow();
        setWorkflowId(currentWorkflowId);
      }

      // æ„å»ºå‚æ•°
      const parameters: any = {
        to: formData.to.split(',').map(e => e.trim()).filter(e => e),
        subject: formData.subject,
        body: formData.body,
        smtp_server: formData.smtpServer,
        port: formData.port,
        username: formData.username,
        password: formData.password,
        use_tls: formData.useTls,
        content_type: formData.contentType
      };

      // æ·»åŠ å¯é€‰çš„CCå’ŒBCC
      if (formData.cc.trim()) {
        parameters.cc = formData.cc.split(',').map(e => e.trim()).filter(e => e);
      }
      if (formData.bcc.trim()) {
        parameters.bcc = formData.bcc.split(',').map(e => e.trim()).filter(e => e);
      }

      const requestBody: any = {
        user_id: USER_ID,
        input_data: {},
        execution_context: {
          override_parameters: parameters
        }
      };

      const response = await fetch(
        `http://localhost:8002/v1/workflows/${currentWorkflowId}/nodes/email_send_node/execute`,
        {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(requestBody)
        }
      );

      if (!response.ok) {
        throw new Error(`API request failed: ${response.status}`);
      }

      return await response.json();
    } catch (error) {
      console.error('Execute node error:', error);
      throw error;
    }
  };

  // ä¸»æ‰§è¡Œå‡½æ•°
  const handleExecuteNode = async () => {
    setIsLoading(true);
    setLastResult(null);

    try {
      toast({
        title: "å‘é€é‚®ä»¶",
        description: "æ­£åœ¨é€šè¿‡SMTPå‘é€é‚®ä»¶..."
      });

      const result = await executeEmailNode();
      setLastResult(result);

      if (result.status === 'COMPLETED' && result.output_data?.success !== false) {
        toast({
          title: "é‚®ä»¶å‘é€æˆåŠŸï¼",
          description: `é‚®ä»¶å·²æˆåŠŸå‘é€åˆ° ${formData.to}`,
          variant: "default"
        });
      } else {
        toast({
          title: "å‘é€å¤±è´¥",
          description: result.error_message || result.output_data?.error || "é‚®ä»¶å‘é€å‡ºç°é”™è¯¯",
          variant: "destructive"
        });
      }

    } catch (error: any) {
      console.error('Execution error:', error);
      toast({
        title: "æ‰§è¡Œå¤±è´¥",
        description: error.message || "å‘ç”ŸæœªçŸ¥é”™è¯¯",
        variant: "destructive"
      });
    } finally {
      setIsLoading(false);
    }
  };

  // éªŒè¯SMTPè¿æ¥
  const testSmtpConnection = async () => {
    try {
      const response = await fetch('http://localhost:8002/api/v1/credentials/test-connection', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          provider: 'email',
          credentials: {
            smtp_server: formData.smtpServer,
            port: formData.port,
            username: formData.username,
            password: formData.password,
            use_tls: formData.useTls
          }
        })
      });

      const result = await response.json();
      
      if (result.credentials_valid) {
        toast({
          title: "è¿æ¥æˆåŠŸ",
          description: "SMTPæœåŠ¡å™¨è¿æ¥æµ‹è¯•æˆåŠŸ",
          variant: "default"
        });
      } else {
        toast({
          title: "è¿æ¥å¤±è´¥",
          description: result.error || "æ— æ³•è¿æ¥åˆ°SMTPæœåŠ¡å™¨",
          variant: "destructive"
        });
      }
    } catch (error: any) {
      toast({
        title: "æµ‹è¯•å¤±è´¥",
        description: error.message || "è¿æ¥æµ‹è¯•å‡ºç°é”™è¯¯",
        variant: "destructive"
      });
    }
  };

  return (
    <div className="container mx-auto p-6 space-y-6">
      <div className="flex items-center justify-between">
        <div>
          <h1 className="text-3xl font-bold flex items-center gap-2">
            <Mail className="w-8 h-8" />
            Email SMTP é›†æˆæµ‹è¯•
          </h1>
          <p className="text-gray-600 mt-2">
            æµ‹è¯•SMTPé‚®ä»¶å‘é€é›†æˆ - æ”¯æŒHTMLé‚®ä»¶ã€é™„ä»¶ã€CC/BCCç­‰åŠŸèƒ½
          </p>
        </div>
      </div>

      {/* é‚®ä»¶å†…å®¹é…ç½® */}
      <Card>
        <CardHeader>
          <CardTitle className="flex items-center gap-2">
            <FileText className="w-5 h-5" />
            é‚®ä»¶å†…å®¹é…ç½®
          </CardTitle>
        </CardHeader>
        <CardContent className="space-y-4">
          <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div className="space-y-2">
              <Label htmlFor="to">æ”¶ä»¶äºº *</Label>
              <Input
                id="to"
                value={formData.to}
                onChange={(e) => setFormData({...formData, to: e.target.value})}
                placeholder="email1@example.com, email2@example.com"
              />
            </div>
            <div className="space-y-2">
              <Label htmlFor="cc">æŠ„é€ (CC)</Label>
              <Input
                id="cc"
                value={formData.cc}
                onChange={(e) => setFormData({...formData, cc: e.target.value})}
                placeholder="å¯é€‰ï¼Œå¤šä¸ªé‚®ç®±ç”¨é€—å·åˆ†éš”"
              />
            </div>
            <div className="space-y-2">
              <Label htmlFor="bcc">å¯†é€ (BCC)</Label>
              <Input
                id="bcc"
                value={formData.bcc}
                onChange={(e) => setFormData({...formData, bcc: e.target.value})}
                placeholder="å¯é€‰ï¼Œå¤šä¸ªé‚®ç®±ç”¨é€—å·åˆ†éš”"
              />
            </div>
          </div>

          <div className="space-y-2">
            <Label htmlFor="subject">é‚®ä»¶ä¸»é¢˜ *</Label>
            <Input
              id="subject"
              value={formData.subject}
              onChange={(e) => setFormData({...formData, subject: e.target.value})}
              placeholder="è¾“å…¥é‚®ä»¶ä¸»é¢˜"
            />
          </div>

          <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div className="space-y-2">
              <Label htmlFor="contentType">é‚®ä»¶æ ¼å¼</Label>
              <select 
                className="w-full p-2 border rounded-md"
                value={formData.contentType}
                onChange={(e) => setFormData({...formData, contentType: e.target.value as any})}
              >
                <option value="text/html">HTMLæ ¼å¼</option>
                <option value="text/plain">çº¯æ–‡æœ¬</option>
              </select>
            </div>
          </div>

          <div className="space-y-2">
            <Label htmlFor="body">é‚®ä»¶æ­£æ–‡ *</Label>
            <Textarea
              id="body"
              value={formData.body}
              onChange={(e) => setFormData({...formData, body: e.target.value})}
              placeholder={formData.contentType === 'text/html' ? "è¾“å…¥HTMLæ ¼å¼çš„é‚®ä»¶å†…å®¹" : "è¾“å…¥çº¯æ–‡æœ¬é‚®ä»¶å†…å®¹"}
              rows={8}
            />
          </div>
        </CardContent>
      </Card>

      {/* SMTPæœåŠ¡å™¨é…ç½® */}
      <Card>
        <CardHeader>
          <CardTitle className="flex items-center gap-2">
            <Server className="w-5 h-5" />
            SMTPæœåŠ¡å™¨é…ç½®
          </CardTitle>
        </CardHeader>
        <CardContent className="space-y-4">
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div className="space-y-2">
              <Label htmlFor="smtpServer">SMTPæœåŠ¡å™¨ *</Label>
              <Input
                id="smtpServer"
                value={formData.smtpServer}
                onChange={(e) => setFormData({...formData, smtpServer: e.target.value})}
                placeholder="smtp.gmail.com"
              />
            </div>
            <div className="space-y-2">
              <Label htmlFor="port">ç«¯å£ *</Label>
              <Input
                id="port"
                type="number"
                value={formData.port}
                onChange={(e) => setFormData({...formData, port: parseInt(e.target.value) || 587})}
                placeholder="587"
              />
            </div>
          </div>

          <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div className="space-y-2">
              <Label htmlFor="username">ç”¨æˆ·å/é‚®ç®± *</Label>
              <Input
                id="username"
                value={formData.username}
                onChange={(e) => setFormData({...formData, username: e.target.value})}
                placeholder="your-email@gmail.com"
              />
            </div>
            <div className="space-y-2">
              <Label htmlFor="password">å¯†ç /åº”ç”¨ä¸“ç”¨å¯†ç  *</Label>
              <Input
                id="password"
                type="password"
                value={formData.password}
                onChange={(e) => setFormData({...formData, password: e.target.value})}
                placeholder="è¾“å…¥å¯†ç æˆ–åº”ç”¨ä¸“ç”¨å¯†ç "
              />
            </div>
          </div>

          <div className="flex items-center space-x-2">
            <input
              type="checkbox"
              id="useTls"
              checked={formData.useTls}
              onChange={(e) => setFormData({...formData, useTls: e.target.checked})}
              className="w-4 h-4"
            />
            <Label htmlFor="useTls">ä½¿ç”¨TLSåŠ å¯† (æ¨è)</Label>
          </div>

          <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
            <h4 className="font-medium text-yellow-800 mb-2">âš ï¸ å®‰å…¨æç¤º</h4>
            <div className="text-sm text-yellow-700 space-y-1">
              <p>â€¢ <strong>Gmail</strong>: éœ€è¦ä½¿ç”¨åº”ç”¨ä¸“ç”¨å¯†ç ï¼Œä¸èƒ½ä½¿ç”¨æ™®é€šç™»å½•å¯†ç </p>
              <p>â€¢ <strong>Outlook</strong>: æœåŠ¡å™¨ smtp-mail.outlook.com:587</p>
              <p>â€¢ <strong>QQé‚®ç®±</strong>: æœåŠ¡å™¨ smtp.qq.com:587ï¼Œéœ€è¦å¼€å¯SMTPæœåŠ¡</p>
              <p>â€¢ <strong>163é‚®ç®±</strong>: æœåŠ¡å™¨ smtp.163.com:25æˆ–465</p>
            </div>
          </div>

          <Button 
            onClick={testSmtpConnection}
            variant="outline"
            className="w-full"
          >
            <Shield className="w-4 h-4 mr-2" />
            æµ‹è¯•SMTPè¿æ¥
          </Button>
        </CardContent>
      </Card>

      {/* æ‰§è¡ŒæŒ‰é’® */}
      <Card>
        <CardHeader>
          <CardTitle className="flex items-center gap-2">
            <Send className="w-5 h-5" />
            å‘é€é‚®ä»¶
          </CardTitle>
        </CardHeader>
        <CardContent className="space-y-4">
          <div className="bg-green-50 border border-green-200 rounded-lg p-4">
            <h3 className="font-medium text-green-900 mb-2">ğŸ“§ é‚®ä»¶å‘é€æµç¨‹</h3>
            <div className="text-sm text-green-700 space-y-1">
              <p>1. é…ç½®æ”¶ä»¶äººå’Œé‚®ä»¶å†…å®¹</p>
              <p>2. è®¾ç½®æ­£ç¡®çš„SMTPæœåŠ¡å™¨ä¿¡æ¯</p>
              <p>3. å»ºè®®å…ˆæµ‹è¯•SMTPè¿æ¥ç¡®ä¿é…ç½®æ­£ç¡®</p>
              <p>4. ç‚¹å‡»å‘é€é‚®ä»¶æŒ‰é’®</p>
              <p>5. ç³»ç»Ÿå°†é€šè¿‡SMTPæœåŠ¡å™¨å‘é€é‚®ä»¶</p>
              <p>6. æ£€æŸ¥æ”¶ä»¶äººé‚®ç®±ç¡®è®¤é‚®ä»¶æ¥æ”¶</p>
            </div>
          </div>

          <Button 
            onClick={handleExecuteNode}
            disabled={isLoading}
            className="w-full bg-blue-600 hover:bg-blue-700"
            size="lg"
          >
            {isLoading ? (
              <>
                <Loader2 className="w-4 h-4 mr-2 animate-spin" />
                å‘é€ä¸­...
              </>
            ) : (
              <>
                <Mail className="w-4 h-4 mr-2" />
                å‘é€é‚®ä»¶
              </>
            )}
          </Button>

          {/* æ‰§è¡Œç»“æœ */}
          {lastResult && (
            <div className="mt-4 space-y-4">
              <div className="flex items-center gap-2">
                <h4 className="font-medium">æ‰§è¡Œç»“æœ:</h4>
                {lastResult.status === 'COMPLETED' ? (
                  <CheckCircle className="w-4 h-4 text-green-500" />
                ) : (
                  <XCircle className="w-4 h-4 text-red-500" />
                )}
                <Badge 
                  variant={lastResult.status === 'COMPLETED' ? 'default' : 'destructive'}
                >
                  {lastResult.status}
                </Badge>
              </div>

              {/* æˆåŠŸç»“æœå±•ç¤º */}
              {lastResult.status === 'COMPLETED' && lastResult.output_data?.success && (
                <div className="bg-green-50 border border-green-200 rounded-lg p-4 space-y-3">
                  <h5 className="font-medium text-green-800 flex items-center gap-2">
                    <CheckCircle className="w-4 h-4" />
                    é‚®ä»¶å‘é€æˆåŠŸï¼
                  </h5>
                  
                  <div className="space-y-2 text-sm">
                    {lastResult.output_data.recipients && (
                      <div>
                        <p><strong>æ”¶ä»¶äººç»Ÿè®¡:</strong></p>
                        <ul className="ml-4 space-y-1">
                          <li>â€¢ æ”¶ä»¶äºº (TO): {lastResult.output_data.recipients.to?.join(', ') || 'æ— '}</li>
                          {lastResult.output_data.recipients.cc?.length > 0 && (
                            <li>â€¢ æŠ„é€ (CC): {lastResult.output_data.recipients.cc.join(', ')}</li>
                          )}
                          {lastResult.output_data.recipients.bcc?.length > 0 && (
                            <li>â€¢ å¯†é€ (BCC): {lastResult.output_data.recipients.bcc.join(', ')}</li>
                          )}
                          <li>â€¢ æ€»æ”¶ä»¶äºº: {lastResult.output_data.recipients.total} äºº</li>
                        </ul>
                      </div>
                    )}
                    
                    <p><strong>é‚®ä»¶ä¸»é¢˜:</strong> {lastResult.output_data.subject}</p>
                    <p><strong>SMTPæœåŠ¡å™¨:</strong> {lastResult.output_data.smtp_server}</p>
                    <p><strong>å‘é€æ—¶é—´:</strong> {lastResult.output_data.sent_at}</p>
                  </div>

                  <div className="bg-blue-50 border border-blue-200 rounded p-3 text-blue-800">
                    <p className="font-medium">ğŸ‰ éªŒè¯æ­¥éª¤ï¼š</p>
                    <p className="text-sm mt-1">
                      1. æ£€æŸ¥æ”¶ä»¶äººé‚®ç®±ï¼ˆåŒ…æ‹¬åƒåœ¾é‚®ä»¶æ–‡ä»¶å¤¹ï¼‰<br/>
                      2. ç¡®è®¤é‚®ä»¶ä¸»é¢˜å’Œå†…å®¹æ˜¯å¦æ­£ç¡®<br/>
                      3. éªŒè¯HTMLæ ¼å¼æ˜¯å¦æ­£å¸¸æ˜¾ç¤º
                    </p>
                  </div>
                </div>
              )}

              {/* è¯¦ç»†å“åº”æ•°æ® */}
              <details className="bg-gray-50 rounded-lg">
                <summary className="cursor-pointer p-3 font-medium text-gray-700 hover:bg-gray-100 rounded-lg">
                  æŸ¥çœ‹è¯¦ç»†å“åº”æ•°æ®
                </summary>
                <div className="p-3 pt-0">
                  <pre className="text-xs overflow-auto max-h-80 bg-white p-3 rounded border">
                    {JSON.stringify(lastResult.output_data, null, 2)}
                  </pre>
                </div>
              </details>

              {lastResult.logs && lastResult.logs.length > 0 && (
                <details className="bg-gray-50 rounded-lg">
                  <summary className="cursor-pointer p-3 font-medium text-gray-700 hover:bg-gray-100 rounded-lg">
                    æŸ¥çœ‹æ‰§è¡Œæ—¥å¿—
                  </summary>
                  <div className="p-3 pt-0">
                    <div className="bg-white rounded border p-3 text-sm space-y-1">
                      {lastResult.logs.map((log, index) => (
                        <div key={index} className="font-mono text-xs">â€¢ {log}</div>
                      ))}
                    </div>
                  </div>
                </details>
              )}
            </div>
          )}
        </CardContent>
      </Card>

      {/* ä½¿ç”¨è¯´æ˜ */}
      <Card>
        <CardHeader>
          <CardTitle>ä½¿ç”¨è¯´æ˜</CardTitle>
        </CardHeader>
        <CardContent className="space-y-3 text-sm text-gray-600">
          <p>â€¢ <strong>HTMLé‚®ä»¶</strong>: æ”¯æŒå¯Œæ–‡æœ¬æ ¼å¼ï¼Œå¯ä»¥åŒ…å«é“¾æ¥ã€å›¾ç‰‡ã€è¡¨æ ¼ç­‰HTMLå…ƒç´ </p>
          <p>â€¢ <strong>çº¯æ–‡æœ¬é‚®ä»¶</strong>: é€‚ç”¨äºç®€å•æ–‡æœ¬å†…å®¹ï¼Œå…¼å®¹æ€§æ›´å¥½</p>
          <p>â€¢ <strong>å¤šæ”¶ä»¶äºº</strong>: TOã€CCã€BCCå­—æ®µéƒ½æ”¯æŒå¤šä¸ªé‚®ç®±åœ°å€ï¼Œç”¨é€—å·åˆ†éš”</p>
          <p>â€¢ <strong>SMTPé…ç½®</strong>: ä¸åŒé‚®ä»¶æœåŠ¡å•†éœ€è¦ä¸åŒçš„SMTPè®¾ç½®</p>
          <p>â€¢ <strong>å®‰å…¨è¿æ¥</strong>: å»ºè®®å¼€å¯TLSåŠ å¯†ä¿è¯ä¼ è¾“å®‰å…¨</p>
          <p>â€¢ <strong>åº”ç”¨å¯†ç </strong>: Gmailç­‰æœåŠ¡éœ€è¦ä½¿ç”¨åº”ç”¨ä¸“ç”¨å¯†ç è€Œéç™»å½•å¯†ç </p>
          <p>â€¢ <strong>è¿æ¥æµ‹è¯•</strong>: å‘é€å‰å¯å…ˆæµ‹è¯•SMTPè¿æ¥ç¡®ä¿é…ç½®æ­£ç¡®</p>
        </CardContent>
      </Card>
    </div>
  );
}