# Workflow Engine 调试指南

## 概述

本指南将帮助你调试整个工作流引擎系统，包括gRPC服务器启动、工作流创建、执行和错误场景测试。

## 系统架构

### 核心组件
1. **gRPC服务器** - 提供工作流管理服务
2. **工作流引擎** - 执行工作流逻辑
3. **节点执行器** - 处理各种节点类型
4. **执行数据收集** - 记录详细的执行信息

### 节点类型
- **TRIGGER_NODE** - 触发器节点
- **AI_AGENT_NODE** - AI代理节点
- **ACTION_NODE** - 动作节点
- **FLOW_NODE** - 流程控制节点
- **TOOL_NODE** - 工具节点
- **MEMORY_NODE** - 内存节点
- **HUMAN_IN_THE_LOOP_NODE** - 人工干预节点
- **EXTERNAL_ACTION_NODE** - 外部动作节点

## 调试步骤

### 1. 启动gRPC服务器

```bash
# 启动调试服务器
python start_debug_server.py
```

服务器将在 `localhost:50051` 上运行。

### 2. 测试基本功能

```bash
# 测试基本gRPC功能
python test_simple_server.py
```

这将测试：
- 健康检查
- 工作流创建
- 工作流获取
- 工作流列表
- 工作流执行
- 执行状态查询

### 3. 完整系统调试

```bash
# 在另一个终端运行完整调试
python debug_complete_system.py
```

这将测试：
- 包含各种节点类型的复杂工作流
- 错误场景处理
- 执行数据收集
- 详细的执行路径记录

## 预设的测试场景

### 成功场景
1. **手动触发器** - 正常启动工作流
2. **AI代理成功** - 使用有效API密钥的AI处理
3. **HTTP请求成功** - 访问有效的API端点
4. **工具调用成功** - 使用HTTP工具获取数据
5. **内存缓冲区** - 存储和检索对话历史

### 错误场景
1. **AI代理错误** - 使用无效API密钥
2. **HTTP请求错误** - 访问不存在的端点（404错误）
3. **人工审批超时** - 设置短超时时间测试超时处理
4. **外部动作错误** - 使用无效的Slack令牌

### 流程控制场景
1. **条件分支** - 基于输入状态的条件判断
2. **并行执行** - 多个节点同时执行
3. **错误处理** - 节点失败时的错误传播

## 执行数据收集

系统会收集以下详细信息：

### 执行路径数据
- 每个节点的执行步骤
- 执行时间和状态
- 输入输出数据
- 错误信息（如果有）

### 节点输入数据
- 实际输入参数
- 连接数据
- 凭证信息
- 静态数据

### 性能指标
- 执行时间
- 内存使用
- 网络请求统计

### 错误数据
- 错误消息和堆栈
- 错误类型和代码
- 修复建议
- 调试信息

## 验证要点

### 1. 工作流创建
- ✅ 工作流成功保存到数据库
- ✅ 所有节点正确创建
- ✅ 连接关系正确建立
- ✅ 静态数据和标签正确设置

### 2. 工作流执行
- ✅ 执行ID正确生成
- ✅ 执行状态正确更新
- ✅ 节点按顺序执行
- ✅ 错误正确传播

### 3. 数据收集
- ✅ 执行路径完整记录
- ✅ 节点输入数据详细记录
- ✅ 错误信息完整捕获
- ✅ 性能指标准确记录

### 4. 错误处理
- ✅ 无效API密钥错误正确处理
- ✅ HTTP 404错误正确处理
- ✅ 超时错误正确处理
- ✅ 错误信息包含修复建议

## 故障排除

### 常见问题

1. **gRPC连接失败**
   - 检查服务器是否在运行
   - 确认端口50051未被占用
   - 检查防火墙设置

2. **Protobuf导入错误**
   - 运行 `python fix_proto_imports.py` 修复导入路径
   - 重新生成protobuf文件

3. **节点执行失败**
   - 检查节点参数配置
   - 验证API密钥和端点
   - 查看详细的错误日志

4. **执行数据不完整**
   - 检查执行引擎配置
   - 验证数据收集开关
   - 查看数据库连接

### 调试命令

```bash
# 检查gRPC服务器状态
grpcurl -plaintext localhost:50051 grpc.health.v1.Health/Check

# 查看服务器日志
tail -f logs/workflow_engine.log

# 检查数据库连接
python -c "from workflow_engine.core.database import get_db; print('DB OK')"

# 测试节点执行器
python test_all_nodes.py
```

## 性能监控

### 关键指标
- 工作流执行时间
- 节点执行成功率
- 错误率统计
- 内存使用情况
- 网络请求延迟

### 监控工具
- 执行数据中的性能指标
- 系统日志
- 数据库查询性能
- gRPC调用统计

## 扩展测试

### 自定义测试场景
1. 创建新的节点类型
2. 添加自定义错误处理
3. 实现新的连接类型
4. 扩展执行数据收集

### 压力测试
1. 并发工作流执行
2. 大量节点的工作流
3. 长时间运行的工作流
4. 高频率的API调用

## 总结

通过这个调试指南，你可以：
1. 验证整个工作流引擎的功能
2. 测试各种错误场景的处理
3. 确保执行数据的完整收集
4. 优化系统性能和稳定性

所有测试都通过gRPC接口进行，确保系统在生产环境中的可靠性。 