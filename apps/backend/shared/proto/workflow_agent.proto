syntax = "proto3";

package workflow_agent;

// 唯一的核心接口 - 处理所有6阶段的对话流程和workflow生成
service WorkflowAgent {
  rpc ProcessConversation(ConversationRequest) returns (stream ConversationResponse);
}

// 对话请求
message ConversationRequest {
  string session_id = 1;
  string user_id = 2;
  string user_message = 3;
  AgentState current_state = 4;           // 状态恢复
  WorkflowContext workflow_context = 5;   // edit/copy时需要
}

// 对话响应流
message ConversationResponse {
  string session_id = 1;
  AgentState updated_state = 2;
  ErrorContent error = 3;

  int64 timestamp = 10;
  bool is_final = 11;                     // 是否为最终响应
}

// Agent状态 - 与WorkflowState完全对应
message AgentState {
  string session_id = 1;
  string user_id = 2;
  WorkflowStage stage = 3;
  WorkflowStage previous_stage = 4;
  string intent_summary = 5;
  repeated Conversation conversations = 6;
  repeated string execution_history = 7;
  ClarificationContext clarification_context = 8;
  repeated string gaps = 9;
  repeated AlternativeOption alternatives = 10;
  string current_workflow_json = 11;  // JSON序列化的workflow对象
  string debug_result = 12;
  int32 debug_loop_count = 13;
  WorkflowContext workflow_context = 14;
  RAGContext rag_context = 15;

  int64 created_at = 16;
  int64 updated_at = 17;
}

enum WorkflowStage {
  STAGE_CLARIFICATION = 0;
  STAGE_NEGOTIATION = 1;
  STAGE_GAP_ANALYSIS = 2;
  STAGE_ALTERNATIVE_GENERATION = 3;
  STAGE_WORKFLOW_GENERATION = 4;
  STAGE_DEBUG = 5;
  STAGE_COMPLETED = 6;
  STAGE_ERROR = 7;
}

// 对话记录
message Conversation {
  string role = 1;      // user, assistant, system
  string text = 2;
  int64 timestamp = 3;
  map<string, string> metadata = 4;
}

// 澄清问题
message ClarificationQuestion {
  string id = 1;
  string question = 2;
  string category = 3;    // input, output, trigger, logic
  bool is_required = 4;
  repeated string options = 5;  // 预设选项
}

// 替代方案选项
message AlternativeOption {
  string id = 1;
  string title = 2;
  string description = 3;
  string approach = 4;        // 技术方案描述
  repeated string trade_offs = 5;  // 权衡说明
  string complexity = 6;      // simple, medium, complex
}

// 澄清上下文
message ClarificationContext {
  string purpose = 1;         // initial_intent, template_modification, gap_resolution
  map<string, string> collected_info = 2;
  repeated string pending_questions = 3;
  string origin = 4;          // create, edit, copy
}

// 工作流上下文
message WorkflowContext {
  string origin = 1;          // create, edit, copy
  string source_workflow_id = 2;
  string modification_intent = 3;
}

// 对话配置
message ConversationConfig {
  bool enable_streaming = 1;
  int32 max_turns = 2;
  int32 timeout_seconds = 3;
  string language = 4;          // zh, en
  bool enable_rag = 5;
  map<string, string> preferences = 6;
}

message ErrorContent {
  string error_code = 1;
  string message = 2;
  string details = 3;
  bool is_recoverable = 4;
}

// RAG上下文 (对应WorkflowState.rag)
message RAGContext {
  repeated RAGResult results = 1;
  string query = 2;
  int64 timestamp = 3;
  map<string, string> metadata = 4;
}

message RAGResult {
  string id = 1;
  string node_type = 2;
  string title = 3;
  string description = 4;
  string content = 5;
  float similarity = 6;
  map<string, string> metadata = 7;
}